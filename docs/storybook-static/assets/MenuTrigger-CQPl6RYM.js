import{E as X,f as be}from"./empty-BwNtW-GQ.js";import{r}from"./index-Br2IOmUs.js";import{r as L}from"./index-B1jiiJTD.js";import{u as $}from"./useTimeout-DEENwbcq.js";import{o as k}from"./owner-CQsS7OFZ.js";import{u as h}from"./useStableCallback-CgA2ffE5.js";import{u as xe}from"./useIsoLayoutEffect-B3i3ZXBb.js";import{a as Re,d as Me,e as Ee,u as Oe,b as ve}from"./useInteractions-DLoJm_bm.js";import{u as J,l as ye,m as Ce,n as Fe}from"./MenuSubmenuTrigger-m52R3Z1z.js";import{g as Ie,i as he,a as Pe,b as ke,p as G,F as Y,P as we}from"./popupStateMapping-B2J1S55N.js";import{u as Se}from"./useRenderElement-DBf0zvZM.js";import{a as De,u as Be}from"./useButton-D8OkA_9h.js";import{g as He}from"./getPseudoElementBounds-L0mGlMFL.js";import{C as Ae}from"./CompositeItem-c4Ai6C13.js";import{u as Ue}from"./useBaseUiId-Ds3dA0Bv.js";import{d as je,b as Ne,c as _,f as K}from"./createBaseUIEventDetails-BfRHIGKf.js";import{j as b}from"./jsx-runtime-D_zvdyIk.js";import{u as Le}from"./useHoverReferenceInteraction-BCD5gqBx.js";import{s as Ge}from"./safePolygon-B1_E0Dln.js";import{u as Ye}from"./useClick-TS9p-E59.js";import{u as _e}from"./useFocus-Dd2F9aQQ.js";import{u as Ke}from"./useSyncedFloatingRootContext-BHS4UzMP.js";import{d as P}from"./element-vmEcGomw.js";function Xe(a){const{enabled:s=!0,mouseDownAction:n,open:p}=a,u=r.useRef(!1);return r.useMemo(()=>s?{onMouseDown:x=>{(n==="open"&&!p||n==="close"&&p)&&(u.current=!0,k(x.currentTarget).addEventListener("click",()=>{u.current=!1},{once:!0}))},onClick:x=>{u.current&&(u.current=!1,x.preventBaseUIHandler())}}:X,[s,n,p])}const E=2,xt=r.forwardRef(function(s,n){const{render:p,className:u,disabled:x=!1,nativeButton:q=!0,id:z,openOnHover:Q,delay:V=100,closeDelay:w=0,handle:O,payload:W,...Z}=s,v=J(!0),e=(O==null?void 0:O.store)??(v==null?void 0:v.store);if(!e)throw new Error(be(85));const g=Ue(z),ee=e.useState("isTriggerActive",g),y=e.useState("floatingRootContext"),c=e.useState("isOpenedByTrigger",g),R=r.useRef(null),i=Je(),C=De(!0),S=Re(),M=r.useMemo(()=>S??new Me,[S]),te=Ee(M),re=Oe(),{registerTrigger:oe,isMountedByThisTrigger:D}=Ke(g,R,e,{payload:W,closeDelay:w,parent:i,floatingTreeRoot:M,floatingNodeId:te,floatingParentNodeId:re,keyboardEventRelay:C==null?void 0:C.relayKeyboardEvent}),l=i.type==="menubar",ne=e.useState("disabled"),d=x||ne||l&&i.context.disabled,{getButtonProps:se,buttonRef:ae}=Be({disabled:d,native:q});r.useEffect(()=>{!c&&i.type===void 0&&(e.context.allowMouseUpTriggerRef.current=!1)},[e,c,i.type]);const T=r.useRef(null),B=$(),F=h(t=>{if(!T.current)return;B.clear(),e.context.allowMouseUpTriggerRef.current=!1;const o=t.target;if(P(T.current,o)||P(e.select("positionerElement"),o)||o===T.current||o!=null&&ye(o)===e.select("rootId"))return;const m=He(T.current);t.clientX>=m.left-E&&t.clientX<=m.right+E&&t.clientY>=m.top-E&&t.clientY<=m.bottom+E||M.events.emit("close",{domEvent:t,reason:je})});r.useEffect(()=>{c&&e.select("lastOpenChangeReason")===Ne&&k(T.current).addEventListener("mouseup",F,{once:!0})},[c,F,e]);const I=l&&i.context.hasSubmenuOpen,ue=Le(y,{enabled:(Q??I)&&!d&&i.type!=="context-menu"&&(!l||I&&!D),handleClose:Ge({blockPointerEvents:!l}),mouseOnly:!0,move:!1,restMs:i.type===void 0?V:void 0,delay:{close:w},triggerElementRef:R,externalTree:M,isActiveTrigger:ee}),ce=$e(c,e.select("lastOpenChangeReason")),ie=Ye(y,{enabled:!d&&i.type!=="context-menu",event:c&&l?"click":"mousedown",toggle:!0,ignoreMouse:!1,stickIfOpen:i.type===void 0?ce:!1}),le=_e(y,{enabled:!d&&I}),fe=Xe({open:c,enabled:l,mouseDownAction:"open"}),pe=ve([ie,le]),H=r.useMemo(()=>({disabled:d,open:c}),[d,c]),ge=e.useState("triggerProps",D),A=[T,n,ae,oe,R],U=[pe.getReferenceProps(),ue??X,ge,{"aria-haspopup":"menu",id:g,onMouseDown:t=>{if(e.select("open"))return;B.start(200,()=>{e.context.allowMouseUpTriggerRef.current=!0}),k(t.currentTarget).addEventListener("mouseup",F,{once:!0})}},l?{role:"menuitem"}:{},fe,Z,se],j=r.useRef(null),me=h(t=>{L.flushSync(()=>{e.setOpen(!1,_(K,t.nativeEvent,t.currentTarget))});const o=Ie(j.current);o==null||o.focus()}),de=h(t=>{var m;const o=e.select("positionerElement");if(o&&he(t,o))(m=e.context.beforeContentFocusGuardRef.current)==null||m.focus();else{L.flushSync(()=>{e.setOpen(!1,_(K,t.nativeEvent,t.currentTarget))});let f=Pe(e.context.triggerFocusTargetRef.current||R.current);for(;f!==null&&P(o,f);){const Te=f;if(f=ke(f),f===Te)break}f==null||f.focus()}}),N=Se("button",s,{enabled:!l,stateAttributesMapping:G,state:H,ref:A,props:U});return l?b.jsx(Ae,{tag:"button",render:p,className:u,state:H,refs:A,props:U,stateAttributesMapping:G}):c?b.jsxs(r.Fragment,{children:[b.jsx(Y,{ref:j,onFocus:me},`${g}-pre-focus-guard`),b.jsx(r.Fragment,{children:N},g),b.jsx(Y,{ref:e.context.triggerFocusTargetRef,onFocus:de},`${g}-post-focus-guard`)]}):b.jsx(r.Fragment,{children:N},g)});function $e(a,s){const n=$(),[p,u]=r.useState(!1);return xe(()=>{a&&s==="trigger-hover"?(u(!0),n.start(we,()=>{u(!1)})):a||(n.clear(),u(!1))},[a,s,n]),p}function Je(){const a=Ce(!0),s=J(!0),n=Fe(!0);return r.useMemo(()=>n?{type:"menubar",context:n}:a&&!s?{type:"context-menu",context:a}:{type:void 0},[a,s,n])}export{xt as M};
